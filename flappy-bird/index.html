<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>i just think they're neat</title>
  <!-- <body>
    <label for="colorpicker">Color Picker:</label>
    <input type="color" id="colorpicker" value="#0000ff">
  </body> -->
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: #fff;
    }
    canvas {
      display: block;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.min.js"></script>
  <script src="assets.js"></script>
  <script>
    const framerate = 60;
    const showFrameRate = false;
    const backgroundColor = "#fff";

    const backgroundSpeed = 1;

    let canvasWidth;
    let canvasHeight;
    let scale;

    let bird;

    class Bird {
      constructor(asset, scale, canvasWidth, canvasHeight) {
        this.asset = asset;
        this.update(scale, canvasWidth, canvasHeight);
        this.x = this.canvasWidth/6
        this.y = this.canvasHeight/3
        this.width = this.asset.width * this.scale;
        this.height = this.asset.height * this.scale;
        this.flapSpeed = 0.25
        this.tilt = 0;
        this.velocity = 0;
        this.ticks = 0;
        this.acceleration = 0.15;
        this.jumpHeight = 0.0025;
        this.terminalVelocity = 25;
      }

      update(scale, canvasWidth, canvasHeight) {
        this.scale = scale;
        this.canvasWidth = canvasWidth;
        this.canvasHeight = canvasHeight;
      }

      jump(){
        this.velocity = this.jumpHeight * this.canvasHeight;
        this.ticks = 0;
        console.log(this.canvasWidth, this.canvasHeight)
      }

      move(){
        this.ticks += 1;
        let displacement = this.acceleration * this.ticks * this.ticks - this.velocity * this.ticks;
        if(displacement > this.terminalVelocity){
          displacement = this.terminalVelocity;
        }
        this.y += displacement;
      }

      draw(){
        let imgIndex = ceil(frameCount*this.flapSpeed)%4
        if(imgIndex % 2 == 1) imgIndex = 1;
        let img = this.asset.image[imgIndex];

        imageMode(CENTER);
        translate(this.x+this.width/2, this.y+this.height/2);
        rotate(-PI / 180 * this.tilt);

        image(img, 0, 0, this.width, this.height);

        rotate(PI / 180 * this.tilt);
        translate(-(this.x+this.width/2), -(this.y+this.height/2));
        imageMode(CORNER);
      }
    }

    function drawBackground(){
      let bgHeight = assets.background.height * scale;
      let bgWidth = assets.background.width * scale;
      let repeats = ceil(canvasWidth / bgWidth) + 1;
      let totalWidth = repeats * bgWidth;
      for(let i=0; i<repeats; i++){
        let offset = backgroundSpeed * frameCount + totalWidth - i*bgWidth
        let x_position = totalWidth - offset%totalWidth - bgWidth
        image(assets.background.image, x_position, 0, bgWidth, bgHeight);
      }
    }

    function setupCanvas(){
      calculateCanvas();
      calculateScale();
      createCanvas(canvasWidth, canvasHeight);
    }

    function windowResized() {
      calculateCanvas();
      calculateScale();
      resizeCanvas(canvasWidth, canvasHeight);
      bird.update(scale, canvasWidth, canvasHeight);
    }

    function calculateCanvas(){
      canvasWidth = windowWidth;
      canvasHeight = windowHeight;
    }

    function loadImages(){
      for(let key of Object.keys(assets)){
        if(typeof assets[key].image == 'string'){
          assets[key].image = loadImage(assets[key].image);
        }
        else{
          for(let i in assets[key].image){
            assets[key].image[i] = loadImage(assets[key].image[i]);
          }
        }
      }
    }

    function calculateScale(){
      scale = canvasHeight/assets.background.height
    }

    function keyPressed() {
      bird.jump();
    }

    function setup(){
    loadImages();
      setupCanvas();
      if(framerate)
        frameRate(framerate);
      else noLoop();
      bird = new Bird(assets.bird, scale, canvasWidth, canvasHeight);
    }

    function draw(){
      drawBackground();

      bird.draw();
      bird.move();

      drawInfo();
    }

    function drawInfo(){
      textSize(12);
      fill(255,255,0);
      stroke(backgroundColor);
      if(showFrameRate) text(parseInt(frameRate()), 20, 20);
      
      // text(document.getElementById("colorpicker").value, 20, 80);
    }
  </script>
</head>

</html>
